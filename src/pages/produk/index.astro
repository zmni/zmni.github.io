---
import { getCollection, type CollectionEntry } from "astro:content"
import { getImage } from "astro:assets"
import PageLayout from "@/layouts/PageLayout.astro"
import { capitalize } from "@/utils/text"
import FilterBar from "@/components/produk/FilterBar.astro"
import FilterGroup from "@/components/produk/FilterGroup.astro"
import ProductGrid from "@/components/produk/ProductGrid.astro"

const meta = {
  label: "Titik Lokasi",
  deskripsi:
    "Lorem ipsum dolor sit amet consectetur adipiscing elit. Dolor sit amet consectetur adipiscing quisque faucibus.",
}

// Koleksi
const produkCollection = await getCollection("produk")

// Produk data
const produkData = await Promise.all(
  produkCollection.map(async item => {
    // Gambar thumbnail
    const image = await getImage({
      src: item.data.gambar,
      width: 400,
      height: 400,
    })

    return {
      id: item.id,
      label: item.data.label,
      alamat: item.data.alamat,
      kabko: item.data.kabko,
      provinsi: item.data.provinsi,
      jenis: item.data.jenis,
      ukuran: item.data.ukuran,
      detailUrl: `/produk/detail/${item.id}/`,
      imageSrc: image.src,
    }
  })
)

// Produk filter/kategori
type FilterKey = keyof CollectionEntry<"produk">["data"]
const filterKeys: FilterKey[] = ["provinsi", "jenis", "ukuran"]
const filterData = Object.fromEntries(
  filterKeys.map(key => [
    key,
    [...new Set(produkCollection.map(p => p.data[key]).filter(Boolean))].sort(),
  ])
) as Record<FilterKey, string[]>
---

<PageLayout {...meta}>
  <FilterBar>
    {
      Object.entries(filterData).map(([key, options]) =>
        key === "provinsi" ? (
          <FilterGroup
            label="Area"
            key={key}
            options={options}
            onChange="if(this.value) window.location.href='/produk/area/' + this.value + '/'; else window.location.href='/produk/'"
          />
        ) : (
          <FilterGroup label={capitalize(key)} key={key} options={options} />
        )
      )
    }
  </FilterBar>

  <ProductGrid products={produkData} />
</PageLayout>
